<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Turret-Tuner Dashboard</title>

  <!-- Bootstrap + Chart.js -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link rel="stylesheet" href="{{ url_for('static', path='style.css') }}">
  <style>
    /* Drag-and-drop styling */
    #file-drop {
      border: 2px dashed #00bcd4;
      padding: 40px 20px;
      text-align: center;
      cursor: pointer;
      transition: background-color 0.2s ease, border-color 0.2s ease;
      color: #e0e0e0;
      margin-bottom: 20px;
      border-radius: 8px;
    }
    #file-drop.dragover {
      background-color: #1a1a1a;
      border-color: #0097a7;
    }
  </style>
</head>

<body>
  <!-- Navbar -->
  <nav class="navbar navbar-dark">
    <div class="container-fluid">
      <a class="navbar-brand" href="#">‚öôÔ∏è Turret-Tuner Dashboard</a>
    </div>
  </nav>

  <div class="container mt-5">
    <div class="row justify-content-center g-4">

      <!-- Choice Card -->
      <div class="col-lg-8">
        <div class="card p-4 text-center">
          <h2>üìä Start Analysis</h2>
          <p>Choose an option below to begin your Bayesian analysis:</p>
          <button id="use-test" class="btn btn-primary m-2 w-50">Use Test Logs</button>
          <button id="upload-own" class="btn btn-primary m-2 w-50">Upload Your Own</button>
        </div>
      </div>

      <!-- Upload Section -->
      <div class="col-lg-8" id="upload-section" style="display:none;">
        <div class="card p-4">
          <h4>üìÅ Upload Your Logs</h4>
          <p>Follow these steps:</p>
          <ol>
            <li>Drag and drop your CSV or JSON file into the box below, or click to select a file.</li>
            <li>Click <strong>Analyze File</strong> to run the Bayesian analysis.</li>
            <li>View suggested coefficients and chart once analysis is complete.</li>
            <li>Click <strong>‚¨áÔ∏è Download PDF Report</strong> if you want to save the results.</li>
          </ol>

          <div id="file-drop">Drag & drop your file here, or click to select.</div>
          <input type="file" id="file-input" name="file" accept=".csv,.json" style="display:none;">

          <button id="analyze-file" class="btn btn-primary w-100">Analyze File</button>

          <div id="upload-loading" class="loading-bar mt-2" style="display:none;">
            <div class="loading-fill"></div>
          </div>
          <div id="upload-status" class="mt-2"></div>
        </div>
      </div>

      <!-- Results Section -->
      <div class="col-lg-8" id="results-section" style="display:none;">
        <div class="card p-4">
          <h4>üìà Analysis Results</h4>
          
          <!-- Table of suggested coefficients -->
          <table class="table table-dark table-striped mt-2" id="coeff-table">
            <thead>
              <tr><th>Coefficient</th><th>Value</th></tr>
            </thead>
            <tbody></tbody>
          </table>

          <!-- Chart -->
          <canvas id="resultsChart"></canvas>

          <!-- PDF button -->
          <button id="generate-pdf" class="btn btn-primary mt-3">‚¨áÔ∏è Download PDF Report</button>
          <div id="pdf-status" class="mt-2"></div>
        </div>
      </div>

    </div>
  </div>

  <script>
    const useTestBtn = document.getElementById('use-test');
    const uploadOwnBtn = document.getElementById('upload-own');
    const uploadSection = document.getElementById('upload-section');
    const fileInput = document.getElementById('file-input');
    const fileDrop = document.getElementById('file-drop');
    const analyzeBtn = document.getElementById('analyze-file');
    const uploadLoading = document.getElementById('upload-loading');
    const uploadStatus = document.getElementById('upload-status');

    const resultsSection = document.getElementById('results-section');
    const coeffTableBody = document.querySelector("#coeff-table tbody");
    const ctx = document.getElementById('resultsChart').getContext('2d');
    let resultsChart;

    const pdfButton = document.getElementById('generate-pdf');
    const pdfStatus = document.getElementById('pdf-status');

    let selectedFile = null;

    // Show upload form
    uploadOwnBtn.addEventListener('click', () => {
      uploadSection.style.display = 'block';
      resultsSection.style.display = 'none';
    });

    // Test logs analysis
    useTestBtn.addEventListener('click', async () => {
      uploadStatus.textContent = '';
      uploadSection.style.display = 'none';
      resultsSection.style.display = 'none';
      uploadLoading.style.display = 'block';

      try {
        const res = await fetch('/run_test', { method: 'POST' });
        const data = await res.json();

        uploadLoading.style.display = 'none';
        resultsSection.style.display = 'block';
        uploadStatus.textContent = "‚úÖ Test analysis complete.";

        populateResults(data);
      } catch (err) {
        uploadLoading.style.display = 'none';
        uploadStatus.textContent = "‚ùå Error running test analysis.";
      }
    });

    // Drag & drop handlers
    fileDrop.addEventListener('click', () => fileInput.click());
    fileDrop.addEventListener('dragover', e => {
      e.preventDefault();
      fileDrop.classList.add('dragover');
    });
    fileDrop.addEventListener('dragleave', e => {
      e.preventDefault();
      fileDrop.classList.remove('dragover');
    });
    fileDrop.addEventListener('drop', e => {
      e.preventDefault();
      fileDrop.classList.remove('dragover');
      selectedFile = e.dataTransfer.files[0];
      fileDrop.textContent = selectedFile.name;
    });
    fileInput.addEventListener('change', () => {
      selectedFile = fileInput.files[0];
      fileDrop.textContent = selectedFile.name;
    });

    // Analyze uploaded file
    analyzeBtn.addEventListener('click', async () => {
      if (!selectedFile) {
        uploadStatus.textContent = "‚ùå Please select a file first.";
        return;
      }

      uploadLoading.style.display = 'block';
      uploadStatus.textContent = "Analyzing data...";

      const formData = new FormData();
      formData.append('file', selectedFile);

      try {
        const res = await fetch('/upload', { method: 'POST', body: formData });
        const data = await res.json();

        uploadLoading.style.display = 'none';
        resultsSection.style.display = 'block';
        uploadStatus.textContent = "‚úÖ Analysis complete.";

        populateResults(data);
      } catch (err) {
        uploadLoading.style.display = 'none';
        uploadStatus.textContent = "‚ùå Error during analysis.";
      }
    });

    function populateResults(data) {
      // Table
      coeffTableBody.innerHTML = '';
      for (const [key, value] of Object.entries(data.tuning_values)) {
        const row = document.createElement('tr');
        row.innerHTML = `<td>${key}</td><td>${value}</td>`;
        coeffTableBody.appendChild(row);
      }

      // Chart
      if (resultsChart) resultsChart.destroy();
      resultsChart = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: Object.keys(data.tuning_values),
          datasets: [{
            label: 'Suggested Coefficients',
            data: Object.values(data.tuning_values),
            backgroundColor: '#00bcd4'
          }]
        },
        options: {
          responsive: true,
          plugins: {
            legend: { display: false },
            title: { display: true, text: 'Recommended Coefficients', color: '#e0e0e0', font: { size: 16 } }
          },
          scales: {
            x: { ticks: { color: '#e0e0e0' } },
            y: { ticks: { color: '#e0e0e0' }, beginAtZero: true }
          }
        }
      });

      pdfButton.dataset.pdfUrl = data.pdf_url;
    }

    // Download PDF
    pdfButton.addEventListener('click', async () => {
      const pdfUrl = pdfButton.dataset.pdfUrl;
      if (!pdfUrl) return;

      try {
        const res = await fetch(pdfUrl);
        if (!res.ok) throw new Error("PDF generation failed");
        const blob = await res.blob();

        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'analysis_report.pdf';
        document.body.appendChild(a);
        a.click();
        a.remove();
        pdfStatus.textContent = "‚úÖ PDF downloaded.";
      } catch (err) {
        pdfStatus.textContent = "‚ùå Error generating PDF.";
      }
    });
  </script>
</body>
</html>
